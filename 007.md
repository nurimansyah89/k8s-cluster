# NGINX Sebagai Load Balancer #
Pada tutorial ini, kita akan mencoba menggunakan [NGINX](NGINX Sebagai Load Balancer) sebagai *LoadBalancer* kluster kita.

Sebelumnya, harap perhatikan pra-syarat dibawah ini.

## Pra-Syarat ##
- Kubernetes Cluster dengan *pod-network* sudah terpasang
- Ingress controller sudah terpasang
- Pisahkan service load balancer ini di external node (Jangan di dalam kluster)
- Pastikan kamu menggunakan type `NodePort` pada **Ingress Controller**-mu

## Instalasi ##
- Tutorial ini menggunakan **Ubuntu 22.04** sebagai OSnya
- Jalankan perintah:
```bash
sudo apt update -y
sudo apt install nginx
```
- Kembali ko local/*host-machine* kamu
- Tambahkan host pada `/etc/hosts`:
```bash
# File: /etc/hosts

...
<ip-service-nginx-kamu> <hostname>
...
```
- Contoh:
```bash
# File: /etc/hosts

...
192.168.56.200 k8s.local
...
```
- Terakhir, dari local/*host-machine*, gunakan perintah `curl`:
```bash
curl k8s.local
```
- Jika berhasil, maka pemasangan **NGINX** selesai dan kamu bisa ke tahap selanjutnya.

## Konfigurasi Load balancer ##
- Backup terlebih dahulu file `/etc/nginx/nginx.conf`
```bash
sudo cp /etc/nginx/nginx.conf /etc/nginx/nginx.conf.bak
```
- Kemudian, buat file baru:
```bash
sudo vi /etc/nginx/nginx.conf
```
- Isikan dengan:
```conf
# Load Balancers
user www-data;
worker_processes auto;
pid /run/nginx.pid;
include /etc/nginx/modules-enabled/*.conf;

events {
	worker_connections 768;
	# multi_accept on;
}

stream {
  upstream httpBackend {
    server <hoster-worker-n>:<port-http-ingress-nginx> max_fails=<berapa-kali-fail-untuk-timeout> fail_timeout=<timeout-untuk-fail>;
    # Isikan dengan ingress node worker yang lain jika ada
    # server <hoster-worker-n>:<port-http-ingress-nginx>;
    # Untuk max_fails=<x> isikan dengan angka saja, contoh: max_fails=3
    # Untuk fail_timeout=<x> isikan dengan angka dan satuan waktu(h: untuk jam, m: untuk menit, s: untuk detik), contoh: fail_timeout=5s
  }

  upstream httpsBackend {
    server <hoster-worker-n>:<port-https-ingress-nginx> max_fails=<berapa-kali-fail-untuk-timeout> fail_timeout=<timeout-untuk-fail>;
    # Isikan dengan ingress node worker yang lain jika ada
    # server <hoster-worker-n>:<port-https-ingress-nginx>;
    # Untuk max_fails=<x> isikan dengan angka saja, contoh: max_fails=3
    # Untuk fail_timeout=<x> isikan dengan angka dan satuan waktu(h: untuk jam, m: untuk menit, s: untuk detik), contoh: fail_timeout=5s
  }
}

server {
  listen          80;
  proxy_pass httpBackend;
}

server {
  listen          443;
  proxy_pass httpsBackend;
}
```
- Simpan
- Verifikasi config NGINX
```bash
sudo nginx -t
```
- Jika tidak ada issue, restart NGINX
```bash
sudo systemctl restart nginx
```

## Contoh Konfigurasi ##
```conf
# File: /etc/nginx/nginx.conf

# Load Balancers
user www-data;
worker_processes auto;
pid /run/nginx.pid;
include /etc/nginx/modules-enabled/*.conf;

events {
	worker_connections 768;
	# multi_accept on;
}

stream {
  upstream httpBackend {
    server worker-1.k8s.local:30080 max_fails=3 fail_timeout=5s;
    server worker-2.k8s.local:30080 max_fails=3 fail_timeout=5s;
  }

  upstream httpsBackend {
    server worker-1.k8s.local:30443 max_fails=3 fail_timeout=5s;
    server worker-2.k8s.local:30443 max_fails=3 fail_timeout=5s;
  }

  server {
    listen          80;
    proxy_pass httpBackend;
  }

  server {
    listen          443;
    proxy_pass httpsBackend;
  }
}
```
> CATATAN: Untuk HTTPS/SSL, NGINX Load Balancer ini hanya mengarahkan ke worker saja. Jadi, pastikan kamu sudah memasang SSL certificate di kluster-mu